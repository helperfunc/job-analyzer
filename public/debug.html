<!DOCTYPE html>
<html>
<head>
    <title>Scraping State Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .active { background-color: #ffeb3b; }
        .inactive { background-color: #e8f5e8; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f5f5f5; padding: 10px; margin: 10px 0; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Scraping State Monitor</h1>
    
    <div id="status" class="status">Checking...</div>
    
    <div>
        <button onclick="checkState()">Check State</button>
        <button onclick="setScraping()">Set Scraping Active</button>
        <button onclick="clearScraping()">Clear Scraping</button>
        <button onclick="startAutoCheck()">Start Auto-Check</button>
        <button onclick="stopAutoCheck()">Stop Auto-Check</button>
    </div>
    
    <div class="log" id="log"></div>

    <script>
        let autoCheckInterval = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function checkState() {
            const state = localStorage.getItem('scraping-in-progress');
            const statusDiv = document.getElementById('status');
            
            if (state) {
                try {
                    const parsed = JSON.parse(state);
                    const now = Date.now();
                    const isActive = parsed.isActive && (now - parsed.timestamp) < 10 * 60 * 1000;
                    const ageSeconds = Math.round((now - parsed.timestamp) / 1000);
                    
                    statusDiv.className = `status ${isActive ? 'active' : 'inactive'}`;
                    statusDiv.innerHTML = `
                        <strong>Scraping State Found:</strong><br>
                        Active: ${isActive ? 'YES' : 'NO'}<br>
                        Age: ${ageSeconds} seconds<br>
                        URL: ${parsed.url || 'Not set'}<br>
                        Raw: ${JSON.stringify(parsed, null, 2)}
                    `;
                    
                    log(`State check: Active=${isActive}, Age=${ageSeconds}s`);
                } catch (error) {
                    statusDiv.className = 'status inactive';
                    statusDiv.innerHTML = `<strong>Error parsing state:</strong> ${error.message}`;
                    log(`Parse error: ${error.message}`);
                }
            } else {
                statusDiv.className = 'status inactive';
                statusDiv.innerHTML = '<strong>No scraping state found</strong>';
                log('No scraping state in localStorage');
            }
        }
        
        function setScraping() {
            const state = {
                isActive: true,
                timestamp: Date.now(),
                url: 'https://openai.com/careers/search/'
            };
            localStorage.setItem('scraping-in-progress', JSON.stringify(state));
            log('Set scraping state to active');
            checkState();
        }
        
        function clearScraping() {
            localStorage.removeItem('scraping-in-progress');
            log('Cleared scraping state');
            checkState();
        }
        
        function startAutoCheck() {
            if (autoCheckInterval) return;
            autoCheckInterval = setInterval(() => {
                checkState();
            }, 2000);
            log('Started auto-checking every 2 seconds');
        }
        
        function stopAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
                log('Stopped auto-checking');
            }
        }
        
        // Check state on load
        window.onload = function() {
            checkState();
            log('Debug page loaded');
        };
    </script>
</body>
</html>